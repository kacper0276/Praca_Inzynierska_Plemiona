<div class="grid-wrapper">
  <div class="top-actions" *ngIf="!isOwnVillage">
    <button class="attack-btn" (click)="startAttack()" [disabled]="isAttacking">
      {{ isAttacking ? "Atak w toku..." : "Atakuj" }}
    </button>
  </div>

  <div class="expand-controls">
    <button
      class="expand-btn left"
      (click)="requestExpansion('left')"
      [disabled]="
        gridSize >= maxGridSize || !canAfford(getCurrentExpansionCost())
      "
      title="Rozszerz w lewo"
    >
      ◀ Rozszerz ({{ getCurrentExpansionCost().wood }}W
      {{ getCurrentExpansionCost().clay }}C
      {{ getCurrentExpansionCost().iron }}I)
    </button>
    <ng-container *ngIf="timeLeft$ | async as gatherSecondsLeft">
      <div class="gather-countdown" *ngIf="gatherSecondsLeft > 0">
        Następne surowce za: <strong>{{ gatherSecondsLeft }}s</strong>
      </div>
    </ng-container>
    <button
      class="expand-btn right"
      (click)="requestExpansion('right')"
      [disabled]="
        gridSize >= maxGridSize || !canAfford(getCurrentExpansionCost())
      "
      title="Rozszerz w prawo"
    >
      Rozszerz ({{ getCurrentExpansionCost().wood }}W
      {{ getCurrentExpansionCost().clay }}C
      {{ getCurrentExpansionCost().iron }}I) ▶
    </button>
  </div>

  <div class="grid-layout">
    <div *ngFor="let row of buildings; let i = index" class="grid-row">
      <div
        *ngFor="let building of row; let j = index"
        class="grid-cell"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event, i, j)"
        (dragenter)="onDragEnter($event, i, j)"
        (dragleave)="onDragLeave($event)"
      >
        <ng-container *ngIf="building">
          <app-building
            [draggable]="true"
            (dragstart)="onDragStart(i, j)"
            (dragend)="onDragEnd($event)"
            [class.is-dragging]="
              draggedBuilding?.row === i && draggedBuilding?.col === j
            "
            [name]="building.name"
            [level]="building.level"
            [imageUrl]="building.imageUrl"
            [health]="building.health"
            [maxHealth]="building.maxHealth"
            (click)="onBuildingClick(i, j)"
          ></app-building>

          <app-radial-menu
            *ngIf="
              activeRadial && activeRadial.row === i && activeRadial.col === j
            "
            [menuOptions]="buildingOptions"
            [forceOpen]="true"
            [showToggle]="false"
            (optionSelected)="handleBuildingMenuOption($event, i, j)"
          ></app-radial-menu>
        </ng-container>
        <ng-container *ngIf="!building">
          <button
            *ngIf="
              !activeEmptyRadial ||
              activeEmptyRadial.row !== i ||
              activeEmptyRadial.col !== j
            "
            class="empty-plot-placeholder"
            (click)="showEmptyRadial($event, i, j)"
          >
            +
          </button>

          <app-radial-menu
            *ngIf="
              activeEmptyRadial &&
              activeEmptyRadial.row === i &&
              activeEmptyRadial.col === j
            "
            [menuOptions]="emptyPlotOptions"
            [showToggle]="true"
            [forceOpen]="true"
            (optionSelected)="handleMenuOption($event, i, j)"
            (toggled)="onEmptyRadialToggled($event, i, j)"
          ></app-radial-menu>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<app-build-modal
  *ngIf="buildMode"
  [availableBuildings]="availableBuildings"
  [resources]="resources"
  [buildRow]="buildRow"
  [buildCol]="buildCol"
  (build)="buildBuilding($event.building, $event.cost)"
  (close)="buildMode = false"
/>

<app-building-details-popup
  *ngIf="selectedBuilding"
  [building]="selectedBuilding"
  [resources]="resources"
  [availableBuildings]="availableBuildings"
  (close)="closePopup()"
  (demolish)="demolishBuilding(selectedBuildingRow!, selectedBuildingCol!)"
  (build)="buildBuilding($event.building, $event.cost)"
  (upgrade)="upgradeBuilding($event)"
></app-building-details-popup>

<div *ngIf="isAttacking" class="attack-overlay">
  <div
    class="army-container"
    [style.transform]="
      'translate(' + attackingArmy.x + 'px, ' + attackingArmy.y + 'px)'
    "
  >
    <div class="hp-bar-container">
      <div class="hp-bar-background">
        <div
          class="hp-bar-foreground"
          [style.width.%]="(attackingArmy.totalHp / attackingArmy.maxHp) * 100"
        ></div>
      </div>
      <span class="hp-bar-text"
        >{{ Math.ceil(attackingArmy.totalHp) }} /
        {{ attackingArmy.maxHp }}</span
      >
    </div>
    <img [src]="attackingArmy.gifUrl" class="army-gif" />
  </div>

  <div
    class="army-container"
    *ngIf="defendingArmy.totalHp > 0"
    [style.transform]="
      'translate(' + defendingArmy.x + 'px, ' + defendingArmy.y + 'px)'
    "
  >
    <div class="hp-bar-container">
      <div class="hp-bar-background">
        <div
          class="hp-bar-foreground enemy"
          [style.width.%]="(defendingArmy.totalHp / defendingArmy.maxHp) * 100"
        ></div>
      </div>
      <span class="hp-bar-text"
        >{{ Math.ceil(defendingArmy.totalHp) }} /
        {{ defendingArmy.maxHp }}</span
      >
    </div>
    <img [src]="defendingArmy.gifUrl" class="army-gif" />
  </div>

  <img
    *ngIf="explosion.show"
    [src]="explosion.gifUrl"
    class="explosion-gif"
    [style.left.px]="explosion.x"
    [style.top.px]="explosion.y"
  />
</div>
