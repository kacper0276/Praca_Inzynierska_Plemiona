<div class="grid-wrapper">
  <div class="top-actions" *ngIf="!isOwnVillage">
    <button class="attack-btn" (click)="startAttack()" [disabled]="isAttacking">
      {{
        isAttacking
          ? ("grid.ATTACK.BTN_IN_PROGRESS" | translate)
          : ("grid.ATTACK.BTN_START" | translate)
      }}
    </button>
  </div>

  <div class="expand-controls" *ngIf="isOwnVillage">
    <button
      class="expand-btn left"
      (click)="requestExpansion('left')"
      [disabled]="
        gridWidth >= maxGridSize || !canAfford(getCurrentExpansionCost())
      "
      [title]="'grid.EXPANSION.BTN_LEFT' | translate"
    >
      ◀ {{ "grid.EXPANSION.BTN_LABEL" | translate }} ({{
        getCurrentExpansionCost().wood
      }}W {{ getCurrentExpansionCost().clay }}C
      {{ getCurrentExpansionCost().iron }}I)
    </button>
    <ng-container *ngIf="timeLeft$ | async as gatherSecondsLeft">
      <div class="gather-countdown" *ngIf="gatherSecondsLeft > 0">
        {{ "grid.GATHER.NEXT_RESOURCES" | translate }}
        <strong>{{ gatherSecondsLeft }}s</strong>
      </div>
    </ng-container>
    <button
      class="expand-btn right"
      (click)="requestExpansion('right')"
      [disabled]="
        gridWidth >= maxGridSize || !canAfford(getCurrentExpansionCost())
      "
      [title]="'grid.EXPANSION.BTN_RIGHT' | translate"
    >
      {{ "grid.EXPANSION.BTN_LABEL" | translate }} ({{
        getCurrentExpansionCost().wood
      }}W {{ getCurrentExpansionCost().clay }}C
      {{ getCurrentExpansionCost().iron }}I) ▶
    </button>
  </div>

  <div class="grid-layout">
    <div
      class="army attacking-army"
      *ngIf="isAttacking"
      [style.left.px]="attackingArmy.x"
      [style.top.px]="attackingArmy.y"
    >
      <div class="hp-bar">
        <div
          class="hp-fill"
          [style.width.%]="(attackingArmy.totalHp / attackingArmy.maxHp) * 100"
        ></div>
      </div>
      <img [src]="attackingArmy.gifUrl" alt="Attacker" />
    </div>

    <div
      class="army defending-army"
      *ngIf="isAttacking"
      [style.left.px]="defendingArmy.x"
      [style.top.px]="defendingArmy.y"
    >
      <div class="hp-bar">
        <div
          class="hp-fill"
          [style.width.%]="(defendingArmy.totalHp / defendingArmy.maxHp) * 100"
        ></div>
      </div>
      <img [src]="defendingArmy.gifUrl" alt="Defender" />
    </div>

    <div
      class="explosion"
      *ngIf="explosion.show"
      [style.left.px]="explosion.x"
      [style.top.px]="explosion.y"
    >
      <img [src]="explosion.gifUrl" alt="Boom" />
    </div>

    <div *ngFor="let row of buildings; let i = index" class="grid-row">
      <div
        *ngFor="let building of row; let j = index"
        class="grid-cell"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event, i, j)"
        (dragenter)="onDragEnter($event, i, j)"
        (dragleave)="onDragLeave($event)"
      >
        <ng-container *ngIf="building">
          <div
            class="construction-overlay"
            *ngIf="getActionState(building) !== 'idle'"
          >
            <div class="timer">
              <ng-container [ngSwitch]="getActionState(building)">
                <span *ngSwitchCase="'construction'">{{
                  "grid.STATUS.CONSTRUCTING" | translate
                }}</span>
                <span *ngSwitchCase="'upgrade'">{{
                  "grid.STATUS.UPGRADING" | translate
                }}</span>
                <span *ngSwitchCase="'repair'">{{
                  "grid.STATUS.REPAIRING" | translate
                }}</span>
              </ng-container>
              {{ getActionTimeLeft(building) | secondsToTime }}
            </div>
            <div class="building-preview">
              {{ building.name }}
              <span *ngIf="getActionState(building) === 'upgrade'">
                Lv {{ building.level }} &rarr; {{ building.level + 1 }}
              </span>
              <span *ngIf="getActionState(building) !== 'upgrade'">
                (Lv {{ building.level }})
              </span>
            </div>
          </div>

          <app-building
            [draggable]="getActionState(building) === 'idle'"
            (dragstart)="onDragStart(i, j)"
            (dragend)="onDragEnd($event)"
            [class.is-dragging]="
              draggedBuilding?.row === i && draggedBuilding?.col === j
            "
            [name]="building.name"
            [level]="building.level"
            [imageUrl]="building.imageUrl"
            [health]="building.health"
            [maxHealth]="building.maxHealth"
            (click)="onBuildingClick(i, j)"
          ></app-building>

          <app-radial-menu
            *ngIf="
              getActionState(building) === 'idle' &&
              activeRadial &&
              activeRadial.row === i &&
              activeRadial.col === j
            "
            [menuOptions]="currentMenuOptions"
            [forceOpen]="true"
            [showToggle]="false"
            (optionSelected)="handleBuildingMenuOption($event, i, j)"
          ></app-radial-menu>
        </ng-container>

        <ng-container *ngIf="!building">
          <button
            *ngIf="
              !activeEmptyRadial ||
              activeEmptyRadial.row !== i ||
              activeEmptyRadial.col !== j
            "
            class="empty-plot-placeholder"
            (click)="showEmptyRadial($event, i, j)"
          >
            +
          </button>

          <app-radial-menu
            *ngIf="
              activeEmptyRadial &&
              activeEmptyRadial.row === i &&
              activeEmptyRadial.col === j
            "
            [menuOptions]="emptyPlotOptions"
            [showToggle]="true"
            [forceOpen]="true"
            (optionSelected)="handleMenuOption($event, i, j)"
            (toggled)="onEmptyRadialToggled($event, i, j)"
          ></app-radial-menu>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<app-build-modal
  *ngIf="buildMode"
  [availableBuildings]="availableBuildings"
  [resources]="resources"
  [buildRow]="buildRow"
  [buildCol]="buildCol"
  (build)="buildBuilding($event.building, $event.cost)"
  (close)="buildMode = false"
>
</app-build-modal>

<app-building-details-popup
  *ngIf="selectedBuilding"
  [building]="selectedBuilding"
  [resources]="resources"
  [availableBuildings]="availableBuildings"
  [isOwnVillage]="isOwnVillage"
  (close)="closePopup()"
  (demolish)="demolishSelected()"
  (build)="buildBuilding($event.building, $event.cost)"
  (upgrade)="upgradeBuilding($event)"
  (repair)="repairBuilding()"
></app-building-details-popup>

<div class="battle-result-modal" *ngIf="battleResult">
  <div class="modal-content">
    <h2>{{ "grid.BATTLE.RESULT_TITLE" | translate }}</h2>

    <div
      class="winner-announcement"
      [class.victory]="battleResult.winner === 'attacker'"
      [class.defeat]="battleResult.winner === 'defender'"
    >
      {{
        battleResult.winner === "attacker"
          ? ("grid.BATTLE.ATTACKER_WINS" | translate)
          : ("grid.BATTLE.DEFENDER_WINS" | translate)
      }}
    </div>

    <div
      class="loot-container"
      *ngIf="battleResult.winner === 'attacker' && battleResult.lootedResources"
    >
      <h4>{{ "grid.BATTLE.LOOT_TITLE" | translate }}</h4>
      <div class="loot-items">
        <div
          class="loot-item wood"
          *ngIf="battleResult.lootedResources.wood > 0"
        >
          <img src="assets/icons/wood.png" alt="Wood" />
          <span>+{{ battleResult.lootedResources.wood }}</span>
        </div>
        <div
          class="loot-item clay"
          *ngIf="battleResult.lootedResources.clay > 0"
        >
          <img src="assets/icons/clay.png" alt="Clay" />
          <span>+{{ battleResult.lootedResources.clay }}</span>
        </div>
        <div
          class="loot-item iron"
          *ngIf="battleResult.lootedResources.iron > 0"
        >
          <img src="assets/icons/iron.png" alt="Iron" />
          <span>+{{ battleResult.lootedResources.iron }}</span>
        </div>
      </div>
    </div>

    <div class="losses-container">
      <div class="losses-column attacker">
        <h4>{{ "grid.BATTLE.ATTACKER" | translate }}</h4>
        <p class="loss-count">-{{ battleResult.attackerLosses }}</p>
      </div>
      <div class="vs-divider">VS</div>
      <div class="losses-column defender">
        <h4>{{ "grid.BATTLE.DEFENDER" | translate }}</h4>
        <p class="loss-count">-{{ battleResult.defenderLosses }}</p>
      </div>
    </div>

    <button class="btn-close" (click)="closePopup()">
      {{ "CLOSE" | translate }}
    </button>
  </div>
</div>
